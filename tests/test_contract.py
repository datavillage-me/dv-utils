"""
Unit test for the contract module.
"""

import unittest
import json
import duckdb

from dv_utils import ContractManager, default_settings

default_settings.load_settings(".env")

collaboration_space_id="ekmdkbfa"
data_descriptor_id_s3="6668af7559b8b33c82a71c87"
data_descriptor_id_gcs="6668af1259b8b33c82a71bba"
data_descriptor_id_azure="6668af5c59b8b33c82a71c72"
data_descriptor_id_file="6668af7559b8b33c82a71c89"

data_descriptor_id_export="676816be90a70cd785ad10ec"

class Test(unittest.TestCase):
    """
    Collection of test related to the contract
    """

    def setUp(self):
        self.ContractManager = ContractManager()


    def test_contract_quality_check(self):
        """
        Try to check a contract of a custom dataset on github with file connector. Use this test to check a quality check that does not pass
        """
        filename = f'tests/fixtures/descriptor_file_{data_descriptor_id_file}.json'
        with open(filename, 'r') as file:
            data = json.load(file)
            self.ContractManager.check_contract_for_data_descriptor(data_descriptor_id_file,data)


        """
        Try to check a contract of a custom dataset on s3
        """
        filename = f'tests/fixtures/descriptor_s3_{data_descriptor_id_s3}.json'
        with open(filename, 'r') as file:
            data = json.load(file)
            self.ContractManager.check_contract_for_data_descriptor(data_descriptor_id_s3,data)


        """
        Try to check a contract of a custom dataset on gcs
        """
        filename = f'tests/fixtures/descriptor_gcs_{data_descriptor_id_gcs}.json'
        with open(filename, 'r') as file:
            data = json.load(file)
            self.ContractManager.check_contract_for_data_descriptor(data_descriptor_id_gcs,data)

        """
        Try to export data to a data consumer
        """
        filename = f'tests/fixtures/descriptor_export_{data_descriptor_id_export}.json'
        with open(filename, 'r') as file:
            model_key="quality_checks"
            data = json.load(file)
            data_contract=self.ContractManager.get_contract_for_data_descriptor(data_descriptor_id_export, data)
            con = duckdb.connect(database=":memory:")
            con=data_contract.connector.add_duck_db_connection(con)
            con.sql(data_contract.export_contract_to_sql_create_table(model_key))
            test_data='''{"definitionName": null, "defaultDataSource": "6766dea490a70cd785ace46e", "dataTimestamp": "2024-12-23T22:30:16+00:00", "scanStartTimestamp": "2024-12-23T22:30:16+00:00", "scanEndTimestamp": "2024-12-23T22:30:16+00:00", "hasErrors": false, "hasWarnings": false, "hasFailures": false, "metrics": [{"identity": "metric-6766dea490a70cd785ace46e-suspicious_accounts-schema", "metricName": "schema", "dataSourceName": "6766dea490a70cd785ace46e", "tableName": "suspicious_accounts", "partitionName": null, "columnName": null, "value": [{"columnName": "account_uuid", "sourceDataType": "varchar"}, {"columnName": "account_number", "sourceDataType": "varchar"}, {"columnName": "account_format", "sourceDataType": "varchar"}, {"columnName": "bank_id", "sourceDataType": "varchar"}, {"columnName": "reporter_bic", "sourceDataType": "varchar"}, {"columnName": "date_added", "sourceDataType": "date"}]}, {"identity": "metric-6766dea490a70cd785ace46e-suspicious_accounts-account_number-missing_count", "metricName": "missing_count", "value": 0, "dataSourceName": "6766dea490a70cd785ace46e"}, {"identity": "metric-6766dea490a70cd785ace46e-suspicious_accounts-account_uuid-missing_count", "metricName": "missing_count", "value": 0, "dataSourceName": "6766dea490a70cd785ace46e"}, {"identity": "metric-6766dea490a70cd785ace46e-suspicious_accounts-date_added-missing_count", "metricName": "missing_count", "value": 0, "dataSourceName": "6766dea490a70cd785ace46e"}, {"identity": "metric-6766dea490a70cd785ace46e-suspicious_accounts-account_format-missing_count", "metricName": "missing_count", "value": 0, "dataSourceName": "6766dea490a70cd785ace46e"}, {"identity": "metric-6766dea490a70cd785ace46e-suspicious_accounts-bank_id-missing_count", "metricName": "missing_count", "value": 0, "dataSourceName": "6766dea490a70cd785ace46e"}, {"identity": "metric-6766dea490a70cd785ace46e-suspicious_accounts-reporter_bic-missing_count", "metricName": "missing_count", "value": 0, "dataSourceName": "6766dea490a70cd785ace46e"}], "checks": [{"identity": "785cd6cc", "name": "Check that field account_uuid is present", "type": "generic", "definition": "checks for suspicious_accounts:\n  - schema:\n      fail:\n        when required column missing:\n          - account_uuid\n      name: Check that field account_uuid is present\n", "resourceAttributes": [], "location": {"filePath": "sodacl_string.yml", "line": 2, "col": 3}, "dataSource": "6766dea490a70cd785ace46e", "table": "suspicious_accounts", "filter": null, "column": null, "metrics": ["metric-6766dea490a70cd785ace46e-suspicious_accounts-schema"], "outcome": "pass", "outcomeReasons": [], "archetype": null, "diagnostics": {"blocks": [{"type": "csv", "text": "Column,Type\naccount_uuid,varchar\naccount_number,varchar\naccount_format,varchar\nbank_id,varchar\nreporter_bic,varchar\ndate_added,date", "title": "Schema"}], "column_additions": [], "column_deletions": [], "column_index_changes": {}, "column_index_mismatches": {}, "column_type_changes": {}, "column_type_mismatches": {}, "missing_column_names": [], "present_column_names": [], "preferredChart": "bars", "valueLabel": "0 schema event(s)", "valueSeries": {"values": [{"label": "fail", "value": 0, "outcome": "fail"}, {"label": "warn", "value": 0, "outcome": "warn"}, {"label": "pass", "value": 6, "outcome": "pass"}]}}}, {"identity": "7da3743a", "name": "Check that field account_uuid has type varchar", "type": "generic", "definition": "checks for suspicious_accounts:\n  - schema:\n      fail:\n        when wrong column type:\n          account_uuid: varchar\n      name: Check that field account_uuid has type varchar\n", "resourceAttributes": [], "location": {"filePath": "sodacl_string.yml", "line": 7, "col": 3}, "dataSource": "6766dea490a70cd785ace46e", "table": "suspicious_accounts", "filter": null, "column": null, "metrics": ["metric-6766dea490a70cd785ace46e-suspicious_accounts-schema"], "outcome": "pass", "outcomeReasons": [], "archetype": null, "diagnostics": {"blocks": [{"type": "csv", "text": "Column,Type\naccount_uuid,varchar\naccount_number,varchar\naccount_format,varchar\nbank_id,varchar\nreporter_bic,varchar\ndate_added,date", "title": "Schema"}], "column_additions": [], "column_deletions": [], "column_index_changes": {}, "column_index_mismatches": {}, "column_type_changes": {}, "column_type_mismatches": {}, "missing_column_names": [], "present_column_names": [], "preferredChart": "bars", "valueLabel": "0 schema event(s)", "valueSeries": {"values": [{"label": "fail", "value": 0, "outcome": "fail"}, {"label": "warn", "value": 0, "outcome": "warn"}, {"label": "pass", "value": 6, "outcome": "pass"}]}}}, {"identity": "cf10449a", "name": "Check that field account_number is present", "type": "generic", "definition": "checks for suspicious_accounts:\n  - schema:\n      fail:\n        when required column missing:\n          - account_number\n      name: Check that field account_number is present\n", "resourceAttributes": [], "location": {"filePath": "sodacl_string.yml", "line": 14, "col": 3}, "dataSource": "6766dea490a70cd785ace46e", "table": "suspicious_accounts", "filter": null, "column": null, "metrics": ["metric-6766dea490a70cd785ace46e-suspicious_accounts-schema"], "outcome": "pass", "outcomeReasons": [], "archetype": null, "diagnostics": {"blocks": [{"type": "csv", "text": "Column,Type\naccount_uuid,varchar\naccount_number,varchar\naccount_format,varchar\nbank_id,varchar\nreporter_bic,varchar\ndate_added,date", "title": "Schema"}], "column_additions": [], "column_deletions": [], "column_index_changes": {}, "column_index_mismatches": {}, "column_type_changes": {}, "column_type_mismatches": {}, "missing_column_names": [], "present_column_names": [], "preferredChart": "bars", "valueLabel": "0 schema event(s)", "valueSeries": {"values": [{"label": "fail", "value": 0, "outcome": "fail"}, {"label": "warn", "value": 0, "outcome": "warn"}, {"label": "pass", "value": 6, "outcome": "pass"}]}}}, {"identity": "6b9b4b52", "name": "Check that field account_number has type varchar", "type": "generic", "definition": "checks for suspicious_accounts:\n  - schema:\n      fail:\n        when wrong column type:\n          account_number: varchar\n      name: Check that field account_number has type varchar\n", "resourceAttributes": [], "location": {"filePath": "sodacl_string.yml", "line": 19, "col": 3}, "dataSource": "6766dea490a70cd785ace46e", "table": "suspicious_accounts", "filter": null, "column": null, "metrics": ["metric-6766dea490a70cd785ace46e-suspicious_accounts-schema"], "outcome": "pass", "outcomeReasons": [], "archetype": null, "diagnostics": {"blocks": [{"type": "csv", "text": "Column,Type\naccount_uuid,varchar\naccount_number,varchar\naccount_format,varchar\nbank_id,varchar\nreporter_bic,varchar\ndate_added,date", "title": "Schema"}], "column_additions": [], "column_deletions": [], "column_index_changes": {}, "column_index_mismatches": {}, "column_type_changes": {}, "column_type_mismatches": {}, "missing_column_names": [], "present_column_names": [], "preferredChart": "bars", "valueLabel": "0 schema event(s)", "valueSeries": {"values": [{"label": "fail", "value": 0, "outcome": "fail"}, {"label": "warn", "value": 0, "outcome": "warn"}, {"label": "pass", "value": 6, "outcome": "pass"}]}}}, {"identity": "9b08cac6", "name": "Check that field account_format is present", "type": "generic", "definition": "checks for suspicious_accounts:\n  - schema:\n      fail:\n        when required column missing:\n          - account_format\n      name: Check that field account_format is present\n", "resourceAttributes": [], "location": {"filePath": "sodacl_string.yml", "line": 26, "col": 3}, "dataSource": "6766dea490a70cd785ace46e", "table": "suspicious_accounts", "filter": null, "column": null, "metrics": ["metric-6766dea490a70cd785ace46e-suspicious_accounts-schema"], "outcome": "pass", "outcomeReasons": [], "archetype": null, "diagnostics": {"blocks": [{"type": "csv", "text": "Column,Type\naccount_uuid,varchar\naccount_number,varchar\naccount_format,varchar\nbank_id,varchar\nreporter_bic,varchar\ndate_added,date", "title": "Schema"}], "column_additions": [], "column_deletions": [], "column_index_changes": {}, "column_index_mismatches": {}, "column_type_changes": {}, "column_type_mismatches": {}, "missing_column_names": [], "present_column_names": [], "preferredChart": "bars", "valueLabel": "0 schema event(s)", "valueSeries": {"values": [{"label": "fail", "value": 0, "outcome": "fail"}, {"label": "warn", "value": 0, "outcome": "warn"}, {"label": "pass", "value": 6, "outcome": "pass"}]}}}, {"identity": "966a7df5", "name": "Check that field account_format has type varchar", "type": "generic", "definition": "checks for suspicious_accounts:\n  - schema:\n      fail:\n        when wrong column type:\n          account_format: varchar\n      name: Check that field account_format has type varchar\n", "resourceAttributes": [], "location": {"filePath": "sodacl_string.yml", "line": 31, "col": 3}, "dataSource": "6766dea490a70cd785ace46e", "table": "suspicious_accounts", "filter": null, "column": null, "metrics": ["metric-6766dea490a70cd785ace46e-suspicious_accounts-schema"], "outcome": "pass", "outcomeReasons": [], "archetype": null, "diagnostics": {"blocks": [{"type": "csv", "text": "Column,Type\naccount_uuid,varchar\naccount_number,varchar\naccount_format,varchar\nbank_id,varchar\nreporter_bic,varchar\ndate_added,date", "title": "Schema"}], "column_additions": [], "column_deletions": [], "column_index_changes": {}, "column_index_mismatches": {}, "column_type_changes": {}, "column_type_mismatches": {}, "missing_column_names": [], "present_column_names": [], "preferredChart": "bars", "valueLabel": "0 schema event(s)", "valueSeries": {"values": [{"label": "fail", "value": 0, "outcome": "fail"}, {"label": "warn", "value": 0, "outcome": "warn"}, {"label": "pass", "value": 6, "outcome": "pass"}]}}}, 
            {"identity": "905ad274", "name": "Check that field bank_id is present", "type": "generic", "definition": "checks for suspicious_accounts:\n  - schema:\n      fail:\n        when required column missing:\n          - bank_id\n      name: Check that field bank_id is present\n", "resourceAttributes": [], "location": {"filePath": "sodacl_string.yml", "line": 38, "col": 3}, "dataSource": "6766dea490a70cd785ace46e", "table": "suspicious_accounts", "filter": null, "column": null, "metrics": ["metric-6766dea490a70cd785ace46e-suspicious_accounts-schema"], "outcome": "pass", "outcomeReasons": [], "archetype": null, "diagnostics": {"blocks": [{"type": "csv", "text": "Column,Type\naccount_uuid,varchar\naccount_number,varchar\naccount_format,varchar\nbank_id,varchar\nreporter_bic,varchar\ndate_added,date", "title": "Schema"}], "column_additions": [], "column_deletions": [], "column_index_changes": {}, "column_index_mismatches": {}, "column_type_changes": {}, "column_type_mismatches": {}, "missing_column_names": [], "present_column_names": [], "preferredChart": "bars", "valueLabel": "0 schema event(s)", "valueSeries": {"values": [{"label": "fail", "value": 0, "outcome": "fail"}, {"label": "warn", "value": 0, "outcome": "warn"}, {"label": "pass", "value": 6, "outcome": "pass"}]}}}, {"identity": "c309fa31", "name": "Check that field bank_id has type varchar", "type": "generic", "definition": "checks for suspicious_accounts:\n  - schema:\n      fail:\n        when wrong column type:\n          bank_id: varchar\n      name: Check that field bank_id has type varchar\n", "resourceAttributes": [], "location": {"filePath": "sodacl_string.yml", "line": 43, "col": 3}, "dataSource": "6766dea490a70cd785ace46e", "table": "suspicious_accounts", "filter": null, "column": null, "metrics": ["metric-6766dea490a70cd785ace46e-suspicious_accounts-schema"], "outcome": "pass", "outcomeReasons": [], "archetype": null, "diagnostics": {"blocks": [{"type": "csv", "text": "Column,Type\naccount_uuid,varchar\naccount_number,varchar\naccount_format,varchar\nbank_id,varchar\nreporter_bic,varchar\ndate_added,date", "title": "Schema"}], "column_additions": [], "column_deletions": [], "column_index_changes": {}, "column_index_mismatches": {}, "column_type_changes": {}, "column_type_mismatches": {}, "missing_column_names": [], "present_column_names": [], "preferredChart": "bars", "valueLabel": "0 schema event(s)", "valueSeries": {"values": [{"label": "fail", "value": 0, "outcome": "fail"}, {"label": "warn", "value": 0, "outcome": "warn"}, {"label": "pass", "value": 6, "outcome": "pass"}]}}}, {"identity": "2776a825", "name": "Check that field reporter_bic is present", "type": "generic", "definition": "checks for suspicious_accounts:\n  - schema:\n      fail:\n        when required column missing:\n          - reporter_bic\n      name: Check that field reporter_bic is present\n", "resourceAttributes": [], "location": {"filePath": "sodacl_string.yml", "line": 50, "col": 3}, "dataSource": "6766dea490a70cd785ace46e", "table": "suspicious_accounts", "filter": null, "column": null, "metrics": ["metric-6766dea490a70cd785ace46e-suspicious_accounts-schema"], "outcome": "pass", "outcomeReasons": [], "archetype": null, "diagnostics": {"blocks": [{"type": "csv", "text": "Column,Type\naccount_uuid,varchar\naccount_number,varchar\naccount_format,varchar\nbank_id,varchar\nreporter_bic,varchar\ndate_added,date", "title": "Schema"}], "column_additions": [], "column_deletions": [], "column_index_changes": {}, "column_index_mismatches": {}, "column_type_changes": {}, "column_type_mismatches": {}, "missing_column_names": [], "present_column_names": [], "preferredChart": "bars", "valueLabel": "0 schema event(s)", "valueSeries": {"values": [{"label": "fail", "value": 0, "outcome": "fail"}, {"label": "warn", "value": 0, "outcome": "warn"}, {"label": "pass", "value": 6, "outcome": "pass"}]}}}, {"identity": "d27aad6b", "name": "Check that field reporter_bic has type varchar", "type": "generic", "definition": "checks for suspicious_accounts:\n  - schema:\n      fail:\n        when wrong column type:\n          reporter_bic: varchar\n      name: Check that field reporter_bic has type varchar\n", "resourceAttributes": [], "location": {"filePath": "sodacl_string.yml", "line": 55, "col": 3}, "dataSource": "6766dea490a70cd785ace46e", "table": "suspicious_accounts", "filter": null, "column": null, "metrics": ["metric-6766dea490a70cd785ace46e-suspicious_accounts-schema"], "outcome": "pass", "outcomeReasons": [], "archetype": null, "diagnostics": {"blocks": [{"type": "csv", "text": "Column,Type\naccount_uuid,varchar\naccount_number,varchar\naccount_format,varchar\nbank_id,varchar\nreporter_bic,varchar\ndate_added,date", "title": "Schema"}], "column_additions": [], "column_deletions": [], "column_index_changes": {}, "column_index_mismatches": {}, "column_type_changes": {}, "column_type_mismatches": {}, "missing_column_names": [], "present_column_names": [], "preferredChart": "bars", "valueLabel": "0 schema event(s)", "valueSeries": {"values": [{"label": "fail", "value": 0, "outcome": "fail"}, {"label": "warn", "value": 0, "outcome": "warn"}, {"label": "pass", "value": 6, "outcome": "pass"}]}}}, {"identity": "70fa70ff", "name": "Check that field date_added is present", "type": "generic", "definition": "checks for suspicious_accounts:\n  - schema:\n      fail:\n        when required column missing:\n          - date_added\n      name: Check that field date_added is present\n", "resourceAttributes": [], "location": {"filePath": "sodacl_string.yml", "line": 62, "col": 3}, "dataSource": "6766dea490a70cd785ace46e", "table": "suspicious_accounts", "filter": null, "column": null, "metrics": ["metric-6766dea490a70cd785ace46e-suspicious_accounts-schema"], "outcome": "pass", "outcomeReasons": [], "archetype": null, "diagnostics": {"blocks": [{"type": "csv", "text": "Column,Type\naccount_uuid,varchar\naccount_number,varchar\naccount_format,varchar\nbank_id,varchar\nreporter_bic,varchar\ndate_added,date", "title": "Schema"}], "column_additions": [], "column_deletions": [], "column_index_changes": {}, "column_index_mismatches": {}, "column_type_changes": {}, "column_type_mismatches": {}, "missing_column_names": [], "present_column_names": [], "preferredChart": "bars", "valueLabel": "0 schema event(s)", "valueSeries": {"values": [{"label": "fail", "value": 0, "outcome": "fail"}, {"label": "warn", "value": 0, "outcome": "warn"}, {"label": "pass", "value": 6, "outcome": "pass"}]}}}, {"identity": "096ab504", "name": "Check that field date_added has type date", "type": "generic", "definition": "checks for suspicious_accounts:\n  - schema:\n      fail:\n        when wrong column type:\n          date_added: date\n      name: Check that field date_added has type date\n", "resourceAttributes": [], "location": {"filePath": "sodacl_string.yml", "line": 67, "col": 3}, "dataSource": "6766dea490a70cd785ace46e", "table": "suspicious_accounts", "filter": null, "column": null, "metrics": ["metric-6766dea490a70cd785ace46e-suspicious_accounts-schema"], "outcome": "pass", "outcomeReasons": [], "archetype": null, "diagnostics": {"blocks": [{"type": "csv", "text": "Column,Type\naccount_uuid,varchar\naccount_number,varchar\naccount_format,varchar\nbank_id,varchar\nreporter_bic,varchar\ndate_added,date", "title": "Schema"}], "column_additions": [], "column_deletions": [], "column_index_changes": {}, "column_index_mismatches": {}, "column_type_changes": {}, "column_type_mismatches": {}, "missing_column_names": [], "present_column_names": [], "preferredChart": "bars", "valueLabel": "0 schema event(s)", "valueSeries": {"values": [{"label": "fail", "value": 0, "outcome": "fail"}, {"label": "warn", "value": 0, "outcome": "warn"}, {"label": "pass", "value": 6, "outcome": "pass"}]}}}, {"identity": "b2c9741e", "name": "Check that required field account_uuid has no null values", "type": "generic", "definition": "checks for suspicious_accounts:\n  - missing_count(account_uuid) = 0:\n      name: Check that required field account_uuid has no null values\n", "resourceAttributes": [], "location": {"filePath": "sodacl_string.yml", "line": 12, "col": 3}, "dataSource": "6766dea490a70cd785ace46e", "table": "suspicious_accounts", "filter": null, "column": "account_uuid", "metrics": ["metric-6766dea490a70cd785ace46e-suspicious_accounts-account_uuid-missing_count"], "outcome": "pass", "outcomeReasons": [], "archetype": null, "diagnostics": {"blocks": [], "value": 0, "fail": {"greaterThan": 0.0, "lessThan": 0.0}}}, {"identity": "f4cfad1f", "name": "Check that required field account_number has no null values", "type": "generic", "definition": "checks for suspicious_accounts:\n  - missing_count(account_number) = 0:\n      name: Check that required field account_number has no null values\n", "resourceAttributes": [], "location": {"filePath": "sodacl_string.yml", "line": 24, "col": 3}, "dataSource": "6766dea490a70cd785ace46e", "table": "suspicious_accounts", "filter": null, "column": "account_number", "metrics": ["metric-6766dea490a70cd785ace46e-suspicious_accounts-account_number-missing_count"], "outcome": "pass", "outcomeReasons": [], "archetype": null, "diagnostics": {"blocks": [], "value": 0, "fail": {"greaterThan": 0.0, "lessThan": 0.0}}}, {"identity": "0d20e471", "name": "Check that required field account_format has no null values", "type": "generic", "definition": "checks for suspicious_accounts:\n  - missing_count(account_format) = 0:\n      name: Check that required field account_format has no null values\n", "resourceAttributes": [], "location": {"filePath": "sodacl_string.yml", "line": 36, "col": 3}, "dataSource": "6766dea490a70cd785ace46e", "table": "suspicious_accounts", "filter": null, "column": "account_format", "metrics": ["metric-6766dea490a70cd785ace46e-suspicious_accounts-account_format-missing_count"], "outcome": "pass", "outcomeReasons": [], "archetype": null, "diagnostics": 
            {"blocks": [], "value": 0, "fail": {"greaterThan": 0.0, "lessThan": 0.0}}}, {"identity": "03ab0ce6", "name": "Check that required field bank_id has no null values", "type": "generic", "definition": "checks for suspicious_accounts:\n  - missing_count(bank_id) = 0:\n      name: Check that required field bank_id has no null values\n", "resourceAttributes": [], "location": {"filePath": "sodacl_string.yml", "line": 48, "col": 3}, "dataSource": "6766dea490a70cd785ace46e", "table": "suspicious_accounts", "filter": null, "column": "bank_id", "metrics": ["metric-6766dea490a70cd785ace46e-suspicious_accounts-bank_id-missing_count"], "outcome": "pass", "outcomeReasons": [], "archetype": null, "diagnostics": {"blocks": [], "value": 0, "fail": {"greaterThan": 0.0, "lessThan": 0.0}}}, {"identity": "486ac26b", "name": "Check that required field reporter_bic has no null values", "type": "generic", "definition": "checks for suspicious_accounts:\n  - missing_count(reporter_bic) = 0:\n      name: Check that required field reporter_bic has no null values\n", "resourceAttributes": [], "location": {"filePath": "sodacl_string.yml", "line": 60, "col": 3}, "dataSource": "6766dea490a70cd785ace46e", "table": "suspicious_accounts", "filter": null, "column": "reporter_bic", "metrics": ["metric-6766dea490a70cd785ace46e-suspicious_accounts-reporter_bic-missing_count"], "outcome": "pass", "outcomeReasons": [], "archetype": null, "diagnostics": {"blocks": [], "value": 0, "fail": {"greaterThan": 0.0, "lessThan": 0.0}}}, {"identity": "57487710", "name": "Check that required field date_added has no null values", "type": "generic", "definition": "checks for suspicious_accounts:\n  - missing_count(date_added) = 0:\n      name: Check that required field date_added has no null values\n", "resourceAttributes": [], "location": {"filePath": "sodacl_string.yml", "line": 72, "col": 3}, "dataSource": "6766dea490a70cd785ace46e", "table": "suspicious_accounts", "filter": null, "column": "date_added", "metrics": ["metric-6766dea490a70cd785ace46e-suspicious_accounts-date_added-missing_count"], "outcome": "pass", "outcomeReasons": [], "archetype": null, "diagnostics": {"blocks": [], "value": 0, "fail": {"greaterThan": 0.0, "lessThan": 0.0}}}], "queries": [{"name": "2.6766dea490a70cd785ace46e.suspicious_accounts.aggregation[0]", "dataSource": "6766dea490a70cd785ace46e", "table": "suspicious_accounts", "partition": null, "column": null, "sql": "SELECT \n  COUNT(CASE WHEN account_uuid IS NULL THEN 1 END),\n  COUNT(CASE WHEN account_number IS NULL THEN 1 END),\n  COUNT(CASE WHEN account_format IS NULL THEN 1 END),\n  COUNT(CASE WHEN bank_id IS NULL THEN 1 END),\n  COUNT(CASE WHEN reporter_bic IS NULL THEN 1 END),\n  COUNT(CASE WHEN date_added IS NULL THEN 1 END) \nFROM suspicious_accounts", "exception": null, "duration": "0:00:00.423090"}, {"name": "1.6766dea490a70cd785ace46e.suspicious_accounts.schema[suspicious_accounts]", "dataSource": "6766dea490a70cd785ace46e", "table": "suspicious_accounts", "partition": null, "column": null, "sql": "SELECT column_name, lower(data_type) as data_type, is_nullable \nFROM information_schema.columns \nWHERE (table_name) = 'suspicious_accounts'\nORDER BY ORDINAL_POSITION", "exception": null, "duration": "0:00:00.033879"}], "automatedMonitoringChecks": [], "profiling": [], "metadata": [], "logs": [{"level": "INFO", "message": "Soda Core 3.3.20", "timestamp": "2024-12-23T22:30:16+00:00", "index": 1, "doc": null, "location": null}, {"level": "INFO", "message": "Scan summary:", "timestamp": "2024-12-23T22:30:16+00:00", "index": 2, "doc": null, "location": null}, {"level": "INFO", "message": "18/18 checks PASSED: ", "timestamp": "2024-12-23T22:30:16+00:00", "index": 3, "doc": null, "location": null}, {"level": "INFO", "message": "    suspicious_accounts in 6766dea490a70cd785ace46e", "timestamp": "2024-12-23T22:30:16+00:00", "index": 4, "doc": null, "location": null}, {"level": "INFO", "message": "      Check that field account_uuid is present [PASSED]", "timestamp": "2024-12-23T22:30:16+00:00", "index": 5, "doc": null, "location": null}, {"level": "INFO", "message": "      Check that field account_uuid has type varchar [PASSED]", "timestamp": "2024-12-23T22:30:16+00:00", "index": 6, "doc": null, "location": null}, {"level": "INFO", "message": "      Check that field account_number is present [PASSED]", "timestamp": "2024-12-23T22:30:16+00:00", "index": 7, "doc": null, "location": null}, {"level": "INFO", "message": "      Check that field account_number has type varchar [PASSED]", "timestamp": "2024-12-23T22:30:16+00:00", "index": 8, "doc": null, "location": null}, {"level": "INFO", "message": "      Check that field account_format is present [PASSED]", "timestamp": "2024-12-23T22:30:16+00:00", "index": 9, "doc": null, "location": null}, {"level": "INFO", "message": "      Check that field account_format has type varchar [PASSED]", "timestamp": "2024-12-23T22:30:16+00:00", "index": 10, "doc": null, "location": null}, {"level": "INFO", "message": "      Check that field bank_id is present [PASSED]", "timestamp": "2024-12-23T22:30:16+00:00", "index": 11, "doc": null, "location": null}, {"level": "INFO", "message": "      Check that field bank_id has type varchar [PASSED]", "timestamp": "2024-12-23T22:30:16+00:00", "index": 12, "doc": null, "location": null}, {"level": "INFO", "message": "      Check that field reporter_bic is present [PASSED]", "timestamp": "2024-12-23T22:30:16+00:00", "index": 13, "doc": null, "location": null}, {"level": "INFO", "message": "      Check that field reporter_bic has type varchar [PASSED]", "timestamp": "2024-12-23T22:30:16+00:00", "index": 14, "doc": null, "location": null}, {"level": "INFO", "message": "      Check that field date_added is present [PASSED]", "timestamp": "2024-12-23T22:30:16+00:00", "index": 15, "doc": null, "location": null}, {"level": "INFO", "message": "      Check that field date_added has type date [PASSED]", "timestamp": "2024-12-23T22:30:16+00:00", "index": 16, "doc": null, "location": null}, {"level": "INFO", "message": "      Check that required field account_uuid has no null values [PASSED]", "timestamp": "2024-12-23T22:30:16+00:00", "index": 17, "doc": null, "location": null}, {"level": "INFO", "message": "      Check that required field account_number has no null values [PASSED]", "timestamp": "2024-12-23T22:30:16+00:00", "index": 18, "doc": null, "location": null}, {"level": "INFO", "message": "      Check that required field account_format has no null values [PASSED]", "timestamp": "2024-12-23T22:30:16+00:00", "index": 19, "doc": null, "location": null}, {"level": "INFO", "message": "      Check that required field bank_id has no null values [PASSED]", "timestamp": "2024-12-23T22:30:16+00:00", "index": 20, "doc": null, "location": null}, {"level": "INFO", "message": "      Check that required field reporter_bic has no null values [PASSED]", "timestamp": "2024-12-23T22:30:16+00:00", "index": 21, "doc": null, "location": null}, {"level": "INFO", "message": "      Check that required field date_added has no null values [PASSED]", "timestamp": "2024-12-23T22:30:16+00:00", "index": 22, "doc": null, "location": null}, {"level": "INFO", "message": "All is good. No failures. No warnings. No errors.", "timestamp": "2024-12-23T22:30:16+00:00", 
            "index": 23, "doc": null, "location": null}]}'''
            con.sql("INSERT INTO "+model_key+" VALUES ('test',true,true,true,'"+test_data.replace("'","''")+"')")
            data_contract.connector.export_duckdb(model_key)

        """
        Try to export signed json data to a data consumer
        """
        filename = f'tests/fixtures/descriptor_export_{data_descriptor_id_export}.json'
        with open(filename, 'r') as file:
            model_key="quality_checks"
            data = json.load(file)
            data_contract=self.ContractManager.get_contract_for_data_descriptor(data_descriptor_id_export, data)
            con = duckdb.connect(database=":memory:")
            con=data_contract.connector.add_duck_db_connection(con)
            con.sql(data_contract.export_contract_to_sql_create_table(model_key))
            test_data='''{"definitionName": null, "defaultDataSource": "6766dea490a70cd785ace46e", "dataTimestamp": "2024-12-23T22:30:16+00:00", "scanStartTimestamp": "2024-12-23T22:30:16+00:00", "scanEndTimestamp": "2024-12-23T22:30:16+00:00", "hasErrors": false, "hasWarnings": false, "hasFailures": false, "metrics": [{"identity": "metric-6766dea490a70cd785ace46e-suspicious_accounts-schema", "metricName": "schema", "dataSourceName": "6766dea490a70cd785ace46e", "tableName": "suspicious_accounts", "partitionName": null, "columnName": null, "value": [{"columnName": "account_uuid", "sourceDataType": "varchar"}, {"columnName": "account_number", "sourceDataType": "varchar"}, {"columnName": "account_format", "sourceDataType": "varchar"}, {"columnName": "bank_id", "sourceDataType": "varchar"}, {"columnName": "reporter_bic", "sourceDataType": "varchar"}, {"columnName": "date_added", "sourceDataType": "date"}]}, {"identity": "metric-6766dea490a70cd785ace46e-suspicious_accounts-account_number-missing_count", "metricName": "missing_count", "value": 0, "dataSourceName": "6766dea490a70cd785ace46e"}, {"identity": "metric-6766dea490a70cd785ace46e-suspicious_accounts-account_uuid-missing_count", "metricName": "missing_count", "value": 0, "dataSourceName": "6766dea490a70cd785ace46e"}, {"identity": "metric-6766dea490a70cd785ace46e-suspicious_accounts-date_added-missing_count", "metricName": "missing_count", "value": 0, "dataSourceName": "6766dea490a70cd785ace46e"}, {"identity": "metric-6766dea490a70cd785ace46e-suspicious_accounts-account_format-missing_count", "metricName": "missing_count", "value": 0, "dataSourceName": "6766dea490a70cd785ace46e"}, {"identity": "metric-6766dea490a70cd785ace46e-suspicious_accounts-bank_id-missing_count", "metricName": "missing_count", "value": 0, "dataSourceName": "6766dea490a70cd785ace46e"}, {"identity": "metric-6766dea490a70cd785ace46e-suspicious_accounts-reporter_bic-missing_count", "metricName": "missing_count", "value": 0, "dataSourceName": "6766dea490a70cd785ace46e"}], "checks": [{"identity": "785cd6cc", "name": "Check that field account_uuid is present", "type": "generic", "definition": "checks for suspicious_accounts:\n  - schema:\n      fail:\n        when required column missing:\n          - account_uuid\n      name: Check that field account_uuid is present\n", "resourceAttributes": [], "location": {"filePath": "sodacl_string.yml", "line": 2, "col": 3}, "dataSource": "6766dea490a70cd785ace46e", "table": "suspicious_accounts", "filter": null, "column": null, "metrics": ["metric-6766dea490a70cd785ace46e-suspicious_accounts-schema"], "outcome": "pass", "outcomeReasons": [], "archetype": null, "diagnostics": {"blocks": [{"type": "csv", "text": "Column,Type\naccount_uuid,varchar\naccount_number,varchar\naccount_format,varchar\nbank_id,varchar\nreporter_bic,varchar\ndate_added,date", "title": "Schema"}], "column_additions": [], "column_deletions": [], "column_index_changes": {}, "column_index_mismatches": {}, "column_type_changes": {}, "column_type_mismatches": {}, "missing_column_names": [], "present_column_names": [], "preferredChart": "bars", "valueLabel": "0 schema event(s)", "valueSeries": {"values": [{"label": "fail", "value": 0, "outcome": "fail"}, {"label": "warn", "value": 0, "outcome": "warn"}, {"label": "pass", "value": 6, "outcome": "pass"}]}}}, {"identity": "7da3743a", "name": "Check that field account_uuid has type varchar", "type": "generic", "definition": "checks for suspicious_accounts:\n  - schema:\n      fail:\n        when wrong column type:\n          account_uuid: varchar\n      name: Check that field account_uuid has type varchar\n", "resourceAttributes": [], "location": {"filePath": "sodacl_string.yml", "line": 7, "col": 3}, "dataSource": "6766dea490a70cd785ace46e", "table": "suspicious_accounts", "filter": null, "column": null, "metrics": ["metric-6766dea490a70cd785ace46e-suspicious_accounts-schema"], "outcome": "pass", "outcomeReasons": [], "archetype": null, "diagnostics": {"blocks": [{"type": "csv", "text": "Column,Type\naccount_uuid,varchar\naccount_number,varchar\naccount_format,varchar\nbank_id,varchar\nreporter_bic,varchar\ndate_added,date", "title": "Schema"}], "column_additions": [], "column_deletions": [], "column_index_changes": {}, "column_index_mismatches": {}, "column_type_changes": {}, "column_type_mismatches": {}, "missing_column_names": [], "present_column_names": [], "preferredChart": "bars", "valueLabel": "0 schema event(s)", "valueSeries": {"values": [{"label": "fail", "value": 0, "outcome": "fail"}, {"label": "warn", "value": 0, "outcome": "warn"}, {"label": "pass", "value": 6, "outcome": "pass"}]}}}, {"identity": "cf10449a", "name": "Check that field account_number is present", "type": "generic", "definition": "checks for suspicious_accounts:\n  - schema:\n      fail:\n        when required column missing:\n          - account_number\n      name: Check that field account_number is present\n", "resourceAttributes": [], "location": {"filePath": "sodacl_string.yml", "line": 14, "col": 3}, "dataSource": "6766dea490a70cd785ace46e", "table": "suspicious_accounts", "filter": null, "column": null, "metrics": ["metric-6766dea490a70cd785ace46e-suspicious_accounts-schema"], "outcome": "pass", "outcomeReasons": [], "archetype": null, "diagnostics": {"blocks": [{"type": "csv", "text": "Column,Type\naccount_uuid,varchar\naccount_number,varchar\naccount_format,varchar\nbank_id,varchar\nreporter_bic,varchar\ndate_added,date", "title": "Schema"}], "column_additions": [], "column_deletions": [], "column_index_changes": {}, "column_index_mismatches": {}, "column_type_changes": {}, "column_type_mismatches": {}, "missing_column_names": [], "present_column_names": [], "preferredChart": "bars", "valueLabel": "0 schema event(s)", "valueSeries": {"values": [{"label": "fail", "value": 0, "outcome": "fail"}, {"label": "warn", "value": 0, "outcome": "warn"}, {"label": "pass", "value": 6, "outcome": "pass"}]}}}, {"identity": "6b9b4b52", "name": "Check that field account_number has type varchar", "type": "generic", "definition": "checks for suspicious_accounts:\n  - schema:\n      fail:\n        when wrong column type:\n          account_number: varchar\n      name: Check that field account_number has type varchar\n", "resourceAttributes": [], "location": {"filePath": "sodacl_string.yml", "line": 19, "col": 3}, "dataSource": "6766dea490a70cd785ace46e", "table": "suspicious_accounts", "filter": null, "column": null, "metrics": ["metric-6766dea490a70cd785ace46e-suspicious_accounts-schema"], "outcome": "pass", "outcomeReasons": [], "archetype": null, "diagnostics": {"blocks": [{"type": "csv", "text": "Column,Type\naccount_uuid,varchar\naccount_number,varchar\naccount_format,varchar\nbank_id,varchar\nreporter_bic,varchar\ndate_added,date", "title": "Schema"}], "column_additions": [], "column_deletions": [], "column_index_changes": {}, "column_index_mismatches": {}, "column_type_changes": {}, "column_type_mismatches": {}, "missing_column_names": [], "present_column_names": [], "preferredChart": "bars", "valueLabel": "0 schema event(s)", "valueSeries": {"values": [{"label": "fail", "value": 0, "outcome": "fail"}, {"label": "warn", "value": 0, "outcome": "warn"}, {"label": "pass", "value": 6, "outcome": "pass"}]}}}, {"identity": "9b08cac6", "name": "Check that field account_format is present", "type": "generic", "definition": "checks for suspicious_accounts:\n  - schema:\n      fail:\n        when required column missing:\n          - account_format\n      name: Check that field account_format is present\n", "resourceAttributes": [], "location": {"filePath": "sodacl_string.yml", "line": 26, "col": 3}, "dataSource": "6766dea490a70cd785ace46e", "table": "suspicious_accounts", "filter": null, "column": null, "metrics": ["metric-6766dea490a70cd785ace46e-suspicious_accounts-schema"], "outcome": "pass", "outcomeReasons": [], "archetype": null, "diagnostics": {"blocks": [{"type": "csv", "text": "Column,Type\naccount_uuid,varchar\naccount_number,varchar\naccount_format,varchar\nbank_id,varchar\nreporter_bic,varchar\ndate_added,date", "title": "Schema"}], "column_additions": [], "column_deletions": [], "column_index_changes": {}, "column_index_mismatches": {}, "column_type_changes": {}, "column_type_mismatches": {}, "missing_column_names": [], "present_column_names": [], "preferredChart": "bars", "valueLabel": "0 schema event(s)", "valueSeries": {"values": [{"label": "fail", "value": 0, "outcome": "fail"}, {"label": "warn", "value": 0, "outcome": "warn"}, {"label": "pass", "value": 6, "outcome": "pass"}]}}}, {"identity": "966a7df5", "name": "Check that field account_format has type varchar", "type": "generic", "definition": "checks for suspicious_accounts:\n  - schema:\n      fail:\n        when wrong column type:\n          account_format: varchar\n      name: Check that field account_format has type varchar\n", "resourceAttributes": [], "location": {"filePath": "sodacl_string.yml", "line": 31, "col": 3}, "dataSource": "6766dea490a70cd785ace46e", "table": "suspicious_accounts", "filter": null, "column": null, "metrics": ["metric-6766dea490a70cd785ace46e-suspicious_accounts-schema"], "outcome": "pass", "outcomeReasons": [], "archetype": null, "diagnostics": {"blocks": [{"type": "csv", "text": "Column,Type\naccount_uuid,varchar\naccount_number,varchar\naccount_format,varchar\nbank_id,varchar\nreporter_bic,varchar\ndate_added,date", "title": "Schema"}], "column_additions": [], "column_deletions": [], "column_index_changes": {}, "column_index_mismatches": {}, "column_type_changes": {}, "column_type_mismatches": {}, "missing_column_names": [], "present_column_names": [], "preferredChart": "bars", "valueLabel": "0 schema event(s)", "valueSeries": {"values": [{"label": "fail", "value": 0, "outcome": "fail"}, {"label": "warn", "value": 0, "outcome": "warn"}, {"label": "pass", "value": 6, "outcome": "pass"}]}}}, 
            {"identity": "905ad274", "name": "Check that field bank_id is present", "type": "generic", "definition": "checks for suspicious_accounts:\n  - schema:\n      fail:\n        when required column missing:\n          - bank_id\n      name: Check that field bank_id is present\n", "resourceAttributes": [], "location": {"filePath": "sodacl_string.yml", "line": 38, "col": 3}, "dataSource": "6766dea490a70cd785ace46e", "table": "suspicious_accounts", "filter": null, "column": null, "metrics": ["metric-6766dea490a70cd785ace46e-suspicious_accounts-schema"], "outcome": "pass", "outcomeReasons": [], "archetype": null, "diagnostics": {"blocks": [{"type": "csv", "text": "Column,Type\naccount_uuid,varchar\naccount_number,varchar\naccount_format,varchar\nbank_id,varchar\nreporter_bic,varchar\ndate_added,date", "title": "Schema"}], "column_additions": [], "column_deletions": [], "column_index_changes": {}, "column_index_mismatches": {}, "column_type_changes": {}, "column_type_mismatches": {}, "missing_column_names": [], "present_column_names": [], "preferredChart": "bars", "valueLabel": "0 schema event(s)", "valueSeries": {"values": [{"label": "fail", "value": 0, "outcome": "fail"}, {"label": "warn", "value": 0, "outcome": "warn"}, {"label": "pass", "value": 6, "outcome": "pass"}]}}}, {"identity": "c309fa31", "name": "Check that field bank_id has type varchar", "type": "generic", "definition": "checks for suspicious_accounts:\n  - schema:\n      fail:\n        when wrong column type:\n          bank_id: varchar\n      name: Check that field bank_id has type varchar\n", "resourceAttributes": [], "location": {"filePath": "sodacl_string.yml", "line": 43, "col": 3}, "dataSource": "6766dea490a70cd785ace46e", "table": "suspicious_accounts", "filter": null, "column": null, "metrics": ["metric-6766dea490a70cd785ace46e-suspicious_accounts-schema"], "outcome": "pass", "outcomeReasons": [], "archetype": null, "diagnostics": {"blocks": [{"type": "csv", "text": "Column,Type\naccount_uuid,varchar\naccount_number,varchar\naccount_format,varchar\nbank_id,varchar\nreporter_bic,varchar\ndate_added,date", "title": "Schema"}], "column_additions": [], "column_deletions": [], "column_index_changes": {}, "column_index_mismatches": {}, "column_type_changes": {}, "column_type_mismatches": {}, "missing_column_names": [], "present_column_names": [], "preferredChart": "bars", "valueLabel": "0 schema event(s)", "valueSeries": {"values": [{"label": "fail", "value": 0, "outcome": "fail"}, {"label": "warn", "value": 0, "outcome": "warn"}, {"label": "pass", "value": 6, "outcome": "pass"}]}}}, {"identity": "2776a825", "name": "Check that field reporter_bic is present", "type": "generic", "definition": "checks for suspicious_accounts:\n  - schema:\n      fail:\n        when required column missing:\n          - reporter_bic\n      name: Check that field reporter_bic is present\n", "resourceAttributes": [], "location": {"filePath": "sodacl_string.yml", "line": 50, "col": 3}, "dataSource": "6766dea490a70cd785ace46e", "table": "suspicious_accounts", "filter": null, "column": null, "metrics": ["metric-6766dea490a70cd785ace46e-suspicious_accounts-schema"], "outcome": "pass", "outcomeReasons": [], "archetype": null, "diagnostics": {"blocks": [{"type": "csv", "text": "Column,Type\naccount_uuid,varchar\naccount_number,varchar\naccount_format,varchar\nbank_id,varchar\nreporter_bic,varchar\ndate_added,date", "title": "Schema"}], "column_additions": [], "column_deletions": [], "column_index_changes": {}, "column_index_mismatches": {}, "column_type_changes": {}, "column_type_mismatches": {}, "missing_column_names": [], "present_column_names": [], "preferredChart": "bars", "valueLabel": "0 schema event(s)", "valueSeries": {"values": [{"label": "fail", "value": 0, "outcome": "fail"}, {"label": "warn", "value": 0, "outcome": "warn"}, {"label": "pass", "value": 6, "outcome": "pass"}]}}}, {"identity": "d27aad6b", "name": "Check that field reporter_bic has type varchar", "type": "generic", "definition": "checks for suspicious_accounts:\n  - schema:\n      fail:\n        when wrong column type:\n          reporter_bic: varchar\n      name: Check that field reporter_bic has type varchar\n", "resourceAttributes": [], "location": {"filePath": "sodacl_string.yml", "line": 55, "col": 3}, "dataSource": "6766dea490a70cd785ace46e", "table": "suspicious_accounts", "filter": null, "column": null, "metrics": ["metric-6766dea490a70cd785ace46e-suspicious_accounts-schema"], "outcome": "pass", "outcomeReasons": [], "archetype": null, "diagnostics": {"blocks": [{"type": "csv", "text": "Column,Type\naccount_uuid,varchar\naccount_number,varchar\naccount_format,varchar\nbank_id,varchar\nreporter_bic,varchar\ndate_added,date", "title": "Schema"}], "column_additions": [], "column_deletions": [], "column_index_changes": {}, "column_index_mismatches": {}, "column_type_changes": {}, "column_type_mismatches": {}, "missing_column_names": [], "present_column_names": [], "preferredChart": "bars", "valueLabel": "0 schema event(s)", "valueSeries": {"values": [{"label": "fail", "value": 0, "outcome": "fail"}, {"label": "warn", "value": 0, "outcome": "warn"}, {"label": "pass", "value": 6, "outcome": "pass"}]}}}, {"identity": "70fa70ff", "name": "Check that field date_added is present", "type": "generic", "definition": "checks for suspicious_accounts:\n  - schema:\n      fail:\n        when required column missing:\n          - date_added\n      name: Check that field date_added is present\n", "resourceAttributes": [], "location": {"filePath": "sodacl_string.yml", "line": 62, "col": 3}, "dataSource": "6766dea490a70cd785ace46e", "table": "suspicious_accounts", "filter": null, "column": null, "metrics": ["metric-6766dea490a70cd785ace46e-suspicious_accounts-schema"], "outcome": "pass", "outcomeReasons": [], "archetype": null, "diagnostics": {"blocks": [{"type": "csv", "text": "Column,Type\naccount_uuid,varchar\naccount_number,varchar\naccount_format,varchar\nbank_id,varchar\nreporter_bic,varchar\ndate_added,date", "title": "Schema"}], "column_additions": [], "column_deletions": [], "column_index_changes": {}, "column_index_mismatches": {}, "column_type_changes": {}, "column_type_mismatches": {}, "missing_column_names": [], "present_column_names": [], "preferredChart": "bars", "valueLabel": "0 schema event(s)", "valueSeries": {"values": [{"label": "fail", "value": 0, "outcome": "fail"}, {"label": "warn", "value": 0, "outcome": "warn"}, {"label": "pass", "value": 6, "outcome": "pass"}]}}}, {"identity": "096ab504", "name": "Check that field date_added has type date", "type": "generic", "definition": "checks for suspicious_accounts:\n  - schema:\n      fail:\n        when wrong column type:\n          date_added: date\n      name: Check that field date_added has type date\n", "resourceAttributes": [], "location": {"filePath": "sodacl_string.yml", "line": 67, "col": 3}, "dataSource": "6766dea490a70cd785ace46e", "table": "suspicious_accounts", "filter": null, "column": null, "metrics": ["metric-6766dea490a70cd785ace46e-suspicious_accounts-schema"], "outcome": "pass", "outcomeReasons": [], "archetype": null, "diagnostics": {"blocks": [{"type": "csv", "text": "Column,Type\naccount_uuid,varchar\naccount_number,varchar\naccount_format,varchar\nbank_id,varchar\nreporter_bic,varchar\ndate_added,date", "title": "Schema"}], "column_additions": [], "column_deletions": [], "column_index_changes": {}, "column_index_mismatches": {}, "column_type_changes": {}, "column_type_mismatches": {}, "missing_column_names": [], "present_column_names": [], "preferredChart": "bars", "valueLabel": "0 schema event(s)", "valueSeries": {"values": [{"label": "fail", "value": 0, "outcome": "fail"}, {"label": "warn", "value": 0, "outcome": "warn"}, {"label": "pass", "value": 6, "outcome": "pass"}]}}}, {"identity": "b2c9741e", "name": "Check that required field account_uuid has no null values", "type": "generic", "definition": "checks for suspicious_accounts:\n  - missing_count(account_uuid) = 0:\n      name: Check that required field account_uuid has no null values\n", "resourceAttributes": [], "location": {"filePath": "sodacl_string.yml", "line": 12, "col": 3}, "dataSource": "6766dea490a70cd785ace46e", "table": "suspicious_accounts", "filter": null, "column": "account_uuid", "metrics": ["metric-6766dea490a70cd785ace46e-suspicious_accounts-account_uuid-missing_count"], "outcome": "pass", "outcomeReasons": [], "archetype": null, "diagnostics": {"blocks": [], "value": 0, "fail": {"greaterThan": 0.0, "lessThan": 0.0}}}, {"identity": "f4cfad1f", "name": "Check that required field account_number has no null values", "type": "generic", "definition": "checks for suspicious_accounts:\n  - missing_count(account_number) = 0:\n      name: Check that required field account_number has no null values\n", "resourceAttributes": [], "location": {"filePath": "sodacl_string.yml", "line": 24, "col": 3}, "dataSource": "6766dea490a70cd785ace46e", "table": "suspicious_accounts", "filter": null, "column": "account_number", "metrics": ["metric-6766dea490a70cd785ace46e-suspicious_accounts-account_number-missing_count"], "outcome": "pass", "outcomeReasons": [], "archetype": null, "diagnostics": {"blocks": [], "value": 0, "fail": {"greaterThan": 0.0, "lessThan": 0.0}}}, {"identity": "0d20e471", "name": "Check that required field account_format has no null values", "type": "generic", "definition": "checks for suspicious_accounts:\n  - missing_count(account_format) = 0:\n      name: Check that required field account_format has no null values\n", "resourceAttributes": [], "location": {"filePath": "sodacl_string.yml", "line": 36, "col": 3}, "dataSource": "6766dea490a70cd785ace46e", "table": "suspicious_accounts", "filter": null, "column": "account_format", "metrics": ["metric-6766dea490a70cd785ace46e-suspicious_accounts-account_format-missing_count"], "outcome": "pass", "outcomeReasons": [], "archetype": null, "diagnostics": 
            {"blocks": [], "value": 0, "fail": {"greaterThan": 0.0, "lessThan": 0.0}}}, {"identity": "03ab0ce6", "name": "Check that required field bank_id has no null values", "type": "generic", "definition": "checks for suspicious_accounts:\n  - missing_count(bank_id) = 0:\n      name: Check that required field bank_id has no null values\n", "resourceAttributes": [], "location": {"filePath": "sodacl_string.yml", "line": 48, "col": 3}, "dataSource": "6766dea490a70cd785ace46e", "table": "suspicious_accounts", "filter": null, "column": "bank_id", "metrics": ["metric-6766dea490a70cd785ace46e-suspicious_accounts-bank_id-missing_count"], "outcome": "pass", "outcomeReasons": [], "archetype": null, "diagnostics": {"blocks": [], "value": 0, "fail": {"greaterThan": 0.0, "lessThan": 0.0}}}, {"identity": "486ac26b", "name": "Check that required field reporter_bic has no null values", "type": "generic", "definition": "checks for suspicious_accounts:\n  - missing_count(reporter_bic) = 0:\n      name: Check that required field reporter_bic has no null values\n", "resourceAttributes": [], "location": {"filePath": "sodacl_string.yml", "line": 60, "col": 3}, "dataSource": "6766dea490a70cd785ace46e", "table": "suspicious_accounts", "filter": null, "column": "reporter_bic", "metrics": ["metric-6766dea490a70cd785ace46e-suspicious_accounts-reporter_bic-missing_count"], "outcome": "pass", "outcomeReasons": [], "archetype": null, "diagnostics": {"blocks": [], "value": 0, "fail": {"greaterThan": 0.0, "lessThan": 0.0}}}, {"identity": "57487710", "name": "Check that required field date_added has no null values", "type": "generic", "definition": "checks for suspicious_accounts:\n  - missing_count(date_added) = 0:\n      name: Check that required field date_added has no null values\n", "resourceAttributes": [], "location": {"filePath": "sodacl_string.yml", "line": 72, "col": 3}, "dataSource": "6766dea490a70cd785ace46e", "table": "suspicious_accounts", "filter": null, "column": "date_added", "metrics": ["metric-6766dea490a70cd785ace46e-suspicious_accounts-date_added-missing_count"], "outcome": "pass", "outcomeReasons": [], "archetype": null, "diagnostics": {"blocks": [], "value": 0, "fail": {"greaterThan": 0.0, "lessThan": 0.0}}}], "queries": [{"name": "2.6766dea490a70cd785ace46e.suspicious_accounts.aggregation[0]", "dataSource": "6766dea490a70cd785ace46e", "table": "suspicious_accounts", "partition": null, "column": null, "sql": "SELECT \n  COUNT(CASE WHEN account_uuid IS NULL THEN 1 END),\n  COUNT(CASE WHEN account_number IS NULL THEN 1 END),\n  COUNT(CASE WHEN account_format IS NULL THEN 1 END),\n  COUNT(CASE WHEN bank_id IS NULL THEN 1 END),\n  COUNT(CASE WHEN reporter_bic IS NULL THEN 1 END),\n  COUNT(CASE WHEN date_added IS NULL THEN 1 END) \nFROM suspicious_accounts", "exception": null, "duration": "0:00:00.423090"}, {"name": "1.6766dea490a70cd785ace46e.suspicious_accounts.schema[suspicious_accounts]", "dataSource": "6766dea490a70cd785ace46e", "table": "suspicious_accounts", "partition": null, "column": null, "sql": "SELECT column_name, lower(data_type) as data_type, is_nullable \nFROM information_schema.columns \nWHERE (table_name) = 'suspicious_accounts'\nORDER BY ORDINAL_POSITION", "exception": null, "duration": "0:00:00.033879"}], "automatedMonitoringChecks": [], "profiling": [], "metadata": [], "logs": [{"level": "INFO", "message": "Soda Core 3.3.20", "timestamp": "2024-12-23T22:30:16+00:00", "index": 1, "doc": null, "location": null}, {"level": "INFO", "message": "Scan summary:", "timestamp": "2024-12-23T22:30:16+00:00", "index": 2, "doc": null, "location": null}, {"level": "INFO", "message": "18/18 checks PASSED: ", "timestamp": "2024-12-23T22:30:16+00:00", "index": 3, "doc": null, "location": null}, {"level": "INFO", "message": "    suspicious_accounts in 6766dea490a70cd785ace46e", "timestamp": "2024-12-23T22:30:16+00:00", "index": 4, "doc": null, "location": null}, {"level": "INFO", "message": "      Check that field account_uuid is present [PASSED]", "timestamp": "2024-12-23T22:30:16+00:00", "index": 5, "doc": null, "location": null}, {"level": "INFO", "message": "      Check that field account_uuid has type varchar [PASSED]", "timestamp": "2024-12-23T22:30:16+00:00", "index": 6, "doc": null, "location": null}, {"level": "INFO", "message": "      Check that field account_number is present [PASSED]", "timestamp": "2024-12-23T22:30:16+00:00", "index": 7, "doc": null, "location": null}, {"level": "INFO", "message": "      Check that field account_number has type varchar [PASSED]", "timestamp": "2024-12-23T22:30:16+00:00", "index": 8, "doc": null, "location": null}, {"level": "INFO", "message": "      Check that field account_format is present [PASSED]", "timestamp": "2024-12-23T22:30:16+00:00", "index": 9, "doc": null, "location": null}, {"level": "INFO", "message": "      Check that field account_format has type varchar [PASSED]", "timestamp": "2024-12-23T22:30:16+00:00", "index": 10, "doc": null, "location": null}, {"level": "INFO", "message": "      Check that field bank_id is present [PASSED]", "timestamp": "2024-12-23T22:30:16+00:00", "index": 11, "doc": null, "location": null}, {"level": "INFO", "message": "      Check that field bank_id has type varchar [PASSED]", "timestamp": "2024-12-23T22:30:16+00:00", "index": 12, "doc": null, "location": null}, {"level": "INFO", "message": "      Check that field reporter_bic is present [PASSED]", "timestamp": "2024-12-23T22:30:16+00:00", "index": 13, "doc": null, "location": null}, {"level": "INFO", "message": "      Check that field reporter_bic has type varchar [PASSED]", "timestamp": "2024-12-23T22:30:16+00:00", "index": 14, "doc": null, "location": null}, {"level": "INFO", "message": "      Check that field date_added is present [PASSED]", "timestamp": "2024-12-23T22:30:16+00:00", "index": 15, "doc": null, "location": null}, {"level": "INFO", "message": "      Check that field date_added has type date [PASSED]", "timestamp": "2024-12-23T22:30:16+00:00", "index": 16, "doc": null, "location": null}, {"level": "INFO", "message": "      Check that required field account_uuid has no null values [PASSED]", "timestamp": "2024-12-23T22:30:16+00:00", "index": 17, "doc": null, "location": null}, {"level": "INFO", "message": "      Check that required field account_number has no null values [PASSED]", "timestamp": "2024-12-23T22:30:16+00:00", "index": 18, "doc": null, "location": null}, {"level": "INFO", "message": "      Check that required field account_format has no null values [PASSED]", "timestamp": "2024-12-23T22:30:16+00:00", "index": 19, "doc": null, "location": null}, {"level": "INFO", "message": "      Check that required field bank_id has no null values [PASSED]", "timestamp": "2024-12-23T22:30:16+00:00", "index": 20, "doc": null, "location": null}, {"level": "INFO", "message": "      Check that required field reporter_bic has no null values [PASSED]", "timestamp": "2024-12-23T22:30:16+00:00", "index": 21, "doc": null, "location": null}, {"level": "INFO", "message": "      Check that required field date_added has no null values [PASSED]", "timestamp": "2024-12-23T22:30:16+00:00", "index": 22, "doc": null, "location": null}, {"level": "INFO", "message": "All is good. No failures. No warnings. No errors.", "timestamp": "2024-12-23T22:30:16+00:00", 
            "index": 23, "doc": null, "location": null}]}'''
            con.sql("INSERT INTO "+model_key+" VALUES ('test',true,true,true,'"+test_data.replace("'","''")+"')")
            data_contract.connector.export_signed_output_duckdb(model_key,collaboration_space_id)
            
        """
        Try to check a contract of a custom dataset on azure
        """
        filename = f'tests/fixtures/descriptor_az_{data_descriptor_id_azure}.json'
        with open(filename, 'r') as file:
            data = json.load(file)
            self.ContractManager.check_contract_for_data_descriptor(data_descriptor_id_azure,data)

        """
        Try to check contract for a collaboration space
        """
        self.ContractManager.check_contracts_for_collaboration_space(collaboration_space_id)

        """
        Try to check a contract of a non-existing collaboration space
        """
        self.ContractManager.check_contracts_for_collaboration_space( None)

        """
        Try to check a contract of a non-existing descriptor 
        """
        self.ContractManager.check_contract_for_data_descriptor(None,None)
